# üèóÔ∏è Stage 1: Build stage
FROM mirror.gcr.io/library/node:22.12.0-slim AS builder

WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ package.json –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
COPY package.json ./
# –ü—Ä–æ–±—É–µ–º —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å yarn.lock (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
RUN if [ -f yarn.lock ]; then cp yarn.lock ./; fi
RUN if [ -f yarn.lock ]; then yarn install --prefer-offline --frozen-lockfile; else yarn install --prefer-offline ; fi

# –ö–æ–ø–∏—Ä—É–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫–∏ –∏ –∫–æ–Ω—Ñ–∏–≥–∏ (–≤—Å—ë –≤ –æ–¥–Ω–æ–º —Å–ª–æ–µ)
COPY tsconfig.json tsconfig.build.json nest-cli.json ./
COPY src ./src

# –°–±–æ—Ä–∫–∞
RUN yarn build

#
FROM mirror.gcr.io/library/node:22.12.0-slim AS runner

WORKDIR /app
# –ö–æ–ø–∏—Ä—É–µ–º package.json/yarn.lock (–¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏)
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json /app/yarn.lock ./
# –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ dist –∏ –Ω—É–∂–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
COPY tsconfig.json nest-cli.json ./
COPY --from=builder /app/dist ./dist

# COPY package.json yarn.lock ./
# RUN npm ci --omit=dev

# # –ö–æ–ø–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ dist (—Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏) –∏ –Ω—É–∂–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏
# COPY --from=builder /app/dist ./dist
# COPY tsconfig.json nest-cli.json ./
COPY .env.development.local ./.env
EXPOSE 4000

CMD ["node", "dist/main"]
